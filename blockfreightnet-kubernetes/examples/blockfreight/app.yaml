---
apiVersion: v1
kind: Service
metadata:
  annotations:
    service.alpha.kubernetes.io/tolerate-unready-endpoints: "true"
  name: blockfreight
  labels:
    app: blockfreight
spec:
  ports:
  - port: 46656
    name: p2p
  - port: 46657
    name: rpc
  clusterIP: None
  selector:
    app: bftx
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: bftx-config
data:
  seeds: "bftx-0,bftx-1,bftx-2,bftx-3"
  validators: "bftx-0,bftx-1,bftx-2,bftx-3"
  validator.power: "10"
  genesis.json: |-
    {
      "genesis_time": "2016-04-26T22:00:00Z",
      "chain_id": "chain-IdealX",
      "validators": [],
      "app_hash": ""
    }
  pub_key_nginx.conf: |-
    server {
      listen 80 default_server;
      listen [::]:80 default_server ipv6only=on;
      location /pub_key.json { root /usr/share/nginx/; }
      location /app_pub_key.json { root /usr/share/nginx/; }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  genesis.json: |-
    {
      "chain_id": "chain-idealX",
      "app_options": {
        "accounts": [
          {
            "pub_key": "bftx-0",
              "Type":"object","Properties":{"Shipper":{"Type":"VLX454323F"},"Bol_Num":{"Type":15554},"Ref_Num":{"Type":154532165},"Consignee":{"Type":""},"Vessel":{"Type":132153456},"Port_of_Loading":{"Type":21514},"Port_of_Discharge":{"Type":51651},"Notify_Address":{"Type":"89-91 City Rd, Southbank 3006, VIC, Australia"},"Desc_of_Goods":{"Type":"This is the goods description."},"Gross_Weight":{"Type":15523},"Freight_Payable_Amt":{"Type":354534},"Freight_Adv_Amt":{"Type":35448552},"General_Instructions":{"Type":"There are many general instructions."},"Date_Shipped":{"Type":20161128,"Format":"date-time"},"Issue_Details":{"Type":"object","Properties":{"Place_of_Issue":{"Type":"Melbourne, Australia"},"Date_of_Issue":{"Type":20161128,"Format":"date-time"}}},"Num_Bol":{"Type":54684010805},"Master_Info":{"Type":"object","Properties":{"First_Name":{"Type":"Master First Name"},"Last_Name":{"Type":"Master Last Name"},"Sig":{"Type":""}}},"Agent_for_Master":{"Type":"object","Properties":{"First_Name":{"Type":"Agent First Name"},"Last_Name":{"Type":"Agent Last Name"},"Sig":{"Type":""}}},"Agent_for_Owner":{"Type":"object","Properties":{"First_Name":{"Type":"Owner First Name"},"Last_Name":{"Type":"Owner Last Name"},"Sig":{"Type":""},"Conditions_for_Carriage":{"Type":"There are the carriage conditions."}}}},"Id":"6cfe5d9e64995953e1941331d93fe0464ff633b49b76e118d237eac237217d4e","PrivateKey":{"Curve":null,"X":74872605968326513813640819827029088867536824131736655385943377933063470927755,"Y":74169953490418118936258226971678637612774441480490590380528644516622620506811,"D":94103966548193441837025018525051725736316925460670810081230278378473583523752},"Signhash":"mEEl+dfNAXCgtAgFNnZjgg==","Signature":"7516513878239122183104497622763227195154250219207219513285238218432442413799520711321860802195362081745662130221184203246831426921634320813527518471339317618267","Verified":true,"Transmitted":true,"Amendment":""

          },
          {
            "pub_key": "bftx-1",
              "Type":"object","Properties":{"Shipper":{"Type":"VLX454323F"},"Bol_Num":{"Type":15554},"Ref_Num":{"Type":154532165},"Consignee":{"Type":""},"Vessel":{"Type":132153456},"Port_of_Loading":{"Type":21514},"Port_of_Discharge":{"Type":51651},"Notify_Address":{"Type":"89-91 City Rd, Southbank 3006, VIC, Australia"},"Desc_of_Goods":{"Type":"This is the goods description."},"Gross_Weight":{"Type":15523},"Freight_Payable_Amt":{"Type":354534},"Freight_Adv_Amt":{"Type":35448552},"General_Instructions":{"Type":"There are many general instructions."},"Date_Shipped":{"Type":20161128,"Format":"date-time"},"Issue_Details":{"Type":"object","Properties":{"Place_of_Issue":{"Type":"Melbourne, Australia"},"Date_of_Issue":{"Type":20161128,"Format":"date-time"}}},"Num_Bol":{"Type":54684010805},"Master_Info":{"Type":"object","Properties":{"First_Name":{"Type":"Master First Name"},"Last_Name":{"Type":"Master Last Name"},"Sig":{"Type":""}}},"Agent_for_Master":{"Type":"object","Properties":{"First_Name":{"Type":"Agent First Name"},"Last_Name":{"Type":"Agent Last Name"},"Sig":{"Type":""}}},"Agent_for_Owner":{"Type":"object","Properties":{"First_Name":{"Type":"Owner First Name"},"Last_Name":{"Type":"Owner Last Name"},"Sig":{"Type":""},"Conditions_for_Carriage":{"Type":"There are the carriage conditions."}}}},"Id":"6cfe5d9e64995953e1941331d93fe0464ff633b49b76e118d237eac237217d4e","PrivateKey":{"Curve":null,"X":74872605968326513813640819827029088867536824131736655385943377933063470927755,"Y":74169953490418118936258226971678637612774441480490590380528644516622620506811,"D":94103966548193441837025018525051725736316925460670810081230278378473583523752},"Signhash":"mEEl+dfNAXCgtAgFNnZjgg==","Signature":"7516513878239122183104497622763227195154250219207219513285238218432442413799520711321860802195362081745662130221184203246831426921634320813527518471339317618267","Verified":true,"Transmitted":true,"Amendment":""
          },
          {
            "pub_key": "bftx-2",
              "Type":"object","Properties":{"Shipper":{"Type":"VLX454323F"},"Bol_Num":{"Type":15554},"Ref_Num":{"Type":154532165},"Consignee":{"Type":""},"Vessel":{"Type":132153456},"Port_of_Loading":{"Type":21514},"Port_of_Discharge":{"Type":51651},"Notify_Address":{"Type":"89-91 City Rd, Southbank 3006, VIC, Australia"},"Desc_of_Goods":{"Type":"This is the goods description."},"Gross_Weight":{"Type":15523},"Freight_Payable_Amt":{"Type":354534},"Freight_Adv_Amt":{"Type":35448552},"General_Instructions":{"Type":"There are many general instructions."},"Date_Shipped":{"Type":20161128,"Format":"date-time"},"Issue_Details":{"Type":"object","Properties":{"Place_of_Issue":{"Type":"Melbourne, Australia"},"Date_of_Issue":{"Type":20161128,"Format":"date-time"}}},"Num_Bol":{"Type":54684010805},"Master_Info":{"Type":"object","Properties":{"First_Name":{"Type":"Master First Name"},"Last_Name":{"Type":"Master Last Name"},"Sig":{"Type":""}}},"Agent_for_Master":{"Type":"object","Properties":{"First_Name":{"Type":"Agent First Name"},"Last_Name":{"Type":"Agent Last Name"},"Sig":{"Type":""}}},"Agent_for_Owner":{"Type":"object","Properties":{"First_Name":{"Type":"Owner First Name"},"Last_Name":{"Type":"Owner Last Name"},"Sig":{"Type":""},"Conditions_for_Carriage":{"Type":"There are the carriage conditions."}}}},"Id":"6cfe5d9e64995953e1941331d93fe0464ff633b49b76e118d237eac237217d4e","PrivateKey":{"Curve":null,"X":74872605968326513813640819827029088867536824131736655385943377933063470927755,"Y":74169953490418118936258226971678637612774441480490590380528644516622620506811,"D":94103966548193441837025018525051725736316925460670810081230278378473583523752},"Signhash":"mEEl+dfNAXCgtAgFNnZjgg==","Signature":"7516513878239122183104497622763227195154250219207219513285238218432442413799520711321860802195362081745662130221184203246831426921634320813527518471339317618267","Verified":true,"Transmitted":true,"Amendment":""

          },
          {
            "pub_key": "bftx-3",
              "Type":"object","Properties":{"Shipper":{"Type":"VLX454323F"},"Bol_Num":{"Type":15554},"Ref_Num":{"Type":154532165},"Consignee":{"Type":""},"Vessel":{"Type":132153456},"Port_of_Loading":{"Type":21514},"Port_of_Discharge":{"Type":51651},"Notify_Address":{"Type":"89-91 City Rd, Southbank 3006, VIC, Australia"},"Desc_of_Goods":{"Type":"This is the goods description."},"Gross_Weight":{"Type":15523},"Freight_Payable_Amt":{"Type":354534},"Freight_Adv_Amt":{"Type":35448552},"General_Instructions":{"Type":"There are many general instructions."},"Date_Shipped":{"Type":20161128,"Format":"date-time"},"Issue_Details":{"Type":"object","Properties":{"Place_of_Issue":{"Type":"Melbourne, Australia"},"Date_of_Issue":{"Type":20161128,"Format":"date-time"}}},"Num_Bol":{"Type":54684010805},"Master_Info":{"Type":"object","Properties":{"First_Name":{"Type":"Master First Name"},"Last_Name":{"Type":"Master Last Name"},"Sig":{"Type":""}}},"Agent_for_Master":{"Type":"object","Properties":{"First_Name":{"Type":"Agent First Name"},"Last_Name":{"Type":"Agent Last Name"},"Sig":{"Type":""}}},"Agent_for_Owner":{"Type":"object","Properties":{"First_Name":{"Type":"Owner First Name"},"Last_Name":{"Type":"Owner Last Name"},"Sig":{"Type":""},"Conditions_for_Carriage":{"Type":"There are the carriage conditions."}}}},"Id":"6cfe5d9e64995953e1941331d93fe0464ff633b49b76e118d237eac237217d4e","PrivateKey":{"Curve":null,"X":74872605968326513813640819827029088867536824131736655385943377933063470927755,"Y":74169953490418118936258226971678637612774441480490590380528644516622620506811,"D":94103966548193441837025018525051725736316925460670810081230278378473583523752},"Signhash":"mEEl+dfNAXCgtAgFNnZjgg==","Signature":"7516513878239122183104497622763227195154250219207219513285238218432442413799520711321860802195362081745662130221184203246831426921634320813527518471339317618267","Verified":true,"Transmitted":true,"Amendment":""
          }
        ]
      }
    }
---
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: bftx-budget
spec:
  selector:
    matchLabels:
      app: bftx
  minAvailable: 2
---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: bftx
spec:
  serviceName: blockfreight
  replicas: 4
  template:
    metadata:
      labels:
        app: bftx
      annotations:
        pod.beta.kubernetes.io/init-containers: '[{
          "name": "tm-gen-validator",
          "image": "tendermint/tendermint:0.10.0",
          "imagePullPolicy": "IfNotPresent",
          "command": ["bash", "-c", "
            set -ex\n
            if [ ! -f /tendermint/priv_validator.json ]; then\n
              tendermint gen_validator > /tendermint/priv_validator.json\n
              # pub_key.json will be served by pub-key container\n
              cat /tendermint/priv_validator.json | jq \".pub_key\" > /tendermint/pub_key.json\n
            fi\n
          "],
          "volumeMounts": [
            {"name": "tmdir", "mountPath": "/tendermint"}
          ]
        },
        {
          "name": "app-gen-key",
          "image": "blockfreight/blockfreight-alpha:latest",
          "imagePullPolicy": "Always",
          "command": ["bash", "-c", "
            set -ex\n
            bftnode new_key > /app/key.json\n
            # pub_key.json will be served by app-pub-key container\n
            cat /app/key.json | jq .pub_key > /app/pub_key.json\n
          "],
          "volumeMounts": [
            {"name": "appdir", "mountPath": "/app"}
          ]
        }]'
    spec:
      containers:
      - name: tm
        imagePullPolicy: Always
        image: tendermint/tendermint:0.10.0
        ports:
        - containerPort: 46656
          name: p2p
        - containerPort: 46657
          name: rpc
        env:
        - name: SEEDS
          valueFrom:
            configMapKeyRef:
              name: bftx-config
              key: seeds
        - name: VALIDATOR_POWER
          valueFrom:
            configMapKeyRef:
              name: bftx-config
              key: validator.power
        - name: VALIDATORS
          valueFrom:
            configMapKeyRef:
              name: bftx-config
              key: validators
        - name: TMHOME
          value: /tendermint
        command:
        - bash
        - "-c"
        - |
          set -ex

          sleep 15
          # copy template
          cp /etc/tendermint/genesis.json /tendermint/genesis.json

          # fill genesis file with validators
          IFS=',' read -ra VALS_ARR <<< "$VALIDATORS"
          fqdn_suffix=$(hostname -f | sed 's#[^.]*\.\(\)#\1#')
          for v in "${VALS_ARR[@]}"; do
            # wait until validator generates priv/pub key pair
            set +e

            curl -s --fail "http://$v.$fqdn_suffix/pub_key.json" > /dev/null
            ERR=$?
            while [ "$ERR" != 0 ]; do
              sleep 5
              curl -s --fail "http://$v.$fqdn_suffix/pub_key.json" > /dev/null
              ERR=$?
            done
            set -e

            # add validator to genesis file along with its pub_key
            curl -s "http://$v.$fqdn_suffix/pub_key.json" | jq ". as \$k | {pub_key: \$k, amount: $VALIDATOR_POWER, name: \"$v\"}" > pub_validator.json
            cat /tendermint/genesis.json | jq ".validators |= .+ [$(cat pub_validator.json)]" > tmpgenesis && mv tmpgenesis /tendermint/genesis.json
            rm pub_validator.json
          done

          # construct seeds
          IFS=',' read -ra SEEDS_ARR <<< "$SEEDS"
          seeds=()
          for s in "${SEEDS_ARR[@]}"; do
            seeds+=("$s.$fqdn_suffix:46656")
          done
          seeds=$(IFS=','; echo "${seeds[*]}")

          tendermint node --p2p.seeds="$seeds" --moniker="`hostname`" --proxy_app="tcp://127.0.0.1:46658"
        volumeMounts:
        - name: tmdir
          mountPath: /tendermint
        - mountPath: /etc/tendermint/genesis.json
          name: tmconfigdir
          subPath: genesis.json
        - name: socksdir
          mountPath: /socks

      - name: app
        imagePullPolicy: Always
        image: blockfreight/blockfreight-alpha:latest
        env:
        - name: BFTXHOME
          value: /blockfreight-alpha
        workingDir: /blockfreight-alpha
        command:
        - bash
        - "-c"
        - |
          set -ex
          # replace "tm-N" with public keys in genesis file
          cp /etc/app/genesis.json genesis.json
          fqdn_suffix=$(hostname -f | sed 's#[^.]*\.\(\)#\1#')
          # for every "base/account"
          i=0
          length=$(cat genesis.json | jq ".app_options.accounts | length")
          while [[ $i -lt $length ]]; do
            # extract pod name ("tm-0")
            pod=$(cat genesis.json | jq -r ".app_options.accounts[$i].pub_key")

            # wait until pod starts to serve its pub_key
            set +e

            curl -s --fail "http://$pod.$fqdn_suffix/app_pub_key.json" > /dev/null
            ERR=$?
            while [ "$ERR" != 0 ]; do
              sleep 5
              curl -s --fail "http://$pod.$fqdn_suffix/app_pub_key.json" > /dev/null
              ERR=$?
            done
            set -e

            # get its pub_key
            curl -s "http://$pod.$fqdn_suffix/app_pub_key.json" | jq "." > k.json

            # replace pod name with it ("tm-0" => "{"type": ..., "data": ...}")
            cat genesis.json | jq ".app_options.accounts[$i].pub_key = $(cat k.json | jq '.')" > tmpgenesis && mv tmpgenesis genesis.json
            rm -f k.json

            i=$((i+1))
          done

          rm -f /socks/app.sock # remove old socket

          bftnode start 
        volumeMounts:
        - name: appdir
          mountPath: /app
        - mountPath: /etc/app/genesis.json
          name: appconfigdir
          subPath: genesis.json
        - name: socksdir
          mountPath: /socks

      - name: pub-key
        imagePullPolicy: IfNotPresent
        image: nginx:latest
        ports:
        - containerPort: 80
        command:
        - bash
        - "-c"
        - |
          set -ex
          # fixes 403 Permission Denied (open() "/tendermint/pub_key.json" failed (13: Permission denied))
          # => we cannot serve from /tendermint, so we copy the file
          mkdir -p /usr/share/nginx
          cp /tendermint/pub_key.json /usr/share/nginx/pub_key.json
          cp /app/pub_key.json /usr/share/nginx/app_pub_key.json
          nginx -g "daemon off;"
        volumeMounts:
        - name: tmdir
          mountPath: /tendermint
        - name: appdir
          mountPath: /app
        - mountPath: /etc/nginx/conf.d/pub_key.conf
          name: tmconfigdir
          subPath: pub_key_nginx.conf

      volumes:
      - name: tmconfigdir
        configMap:
          name: bftx-config
      - name: appconfigdir
        configMap:
          name: app-config
      - name: socksdir
        emptyDir: {}

  volumeClaimTemplates:
  - metadata:
      name: tmdir
      annotations:
        volume.alpha.kubernetes.io/storage-class: anything
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 2Gi
  - metadata:
      name: appdir
      annotations:
        volume.alpha.kubernetes.io/storage-class: anything
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 12Mi
